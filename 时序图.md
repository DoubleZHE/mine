### 用户登录

```sequence
title: 用户登录时序图
participant 用户
用户 -> 登录 Action: 1. 访问登录界面
登录 Action -> 登录界面: [同步消息]\n 2. 转至登录界面
登录界面 -> 登录界面: 3. 输入账号密码
登录界面 -> 登录 Action: [返回消息]\n4. 登录
登录 Action -> 登录 Action: [自关联消息]\n5. 获取账号密码
登录 Action -> UserService: 6. 根据账号密码查询
	Note right of 登录首页: 注：\n该时序图仅表示用户登录成功的情况，\n实际操作中存在各种原因引起的登录失败问题。\n如：网络异常、用户名密码错误、验证码错误等。
UserService -> UserService: 7. 查询 User 表
UserService -->登录 Action: 8. 返回 User 表
登录 Action -> 登录 Action: 9. 从返回表获取 User
登录 Action -> UserService: 10. 根据 userId 查找对应角色
UserService -> UserService: 11. 查询 user_role 表
UserService --> 登录 Action: 12. 返回用户角色
登录 Action -> 登录 Action: 13. 将用户存入 session
登录 Action -> 登录 Action: 14. 将信息写入日志
登录 Action -> 登录首页: 15. 跳转到系统首页
```

```java
//用户登录控制器
@PostMapping("/login")
public Tokens login(@RequestBody @Validated LoginDTO validator) {
    UserDO user = userService.getUserByUsername(validator.getUsername());
    if (user == null) {
        throw new NotFoundException(10021);
    }
    boolean valid = userIdentityService.verifyUsernamePassword(
            user.getId(),
            user.getUsername(),
            validator.getPassword());
    if (!valid) {
        throw new ParameterException(10031);
    }
    // 保存当前登录用户到SingleUtil工具类中
    SingleUtil.userDO = user;
    return jwt.generateTokens(user.getId());
}

//验证用户认证信息 (USERNAME_PASSWORD)
@Override
public boolean verifyUsernamePassword(Integer userId, String username, String password) {
    QueryWrapper<UserIdentityDO> wrapper = new QueryWrapper<>();
    wrapper.lambda().eq(UserIdentityDO::getUserId, userId)
            .eq(UserIdentityDO::getIdentityType, IdentityConstant.USERNAME_PASSWORD_IDENTITY)
            .eq(UserIdentityDO::getIdentifier, username);
    UserIdentityDO userIdentity = this.baseMapper.selectOne(wrapper);
    return EncryptUtil.verify(userIdentity.getCredential(), password);
}
```

### 日志管理

```sequence
title: 日志管理时序图
participant 用户
participant 管理员
用户 -> 系统: 发起操作请求，发送数据
系统 --> 用户: 接收数据，响应请求
管理员 -> 系统: 发起操作请求，发送数据
系统 --> 管理员: 接收数据，响应请求
系统 -> LoggerImpl: 请求和响应信息\n发送至日志信息格式器
LoggerImpl -> LogService: 格式化后的日志信息\n插入 log 数据库表
管理员 -> 日志管理 Action: 访问日志管理界面
	note right of 日志管理界面: 注：\n默认图中该管理员拥有日志管理权限
日志管理 Action -> 日志管理界面: 跳转至日志管理界面
日志管理界面 -> 日志管理界面: 输入条件查询日志
日志管理界面 -> LogService: 查询 log 数据库表
LogService --> 日志管理界面: 返回 log 数据
```

```java
//格式化日志信息的代码
@Slf4j
@Component
public class LoggerImpl implements LoggerResolver {

    @Autowired
    private LogService logService;

    /**
     * 日志格式匹配正则
     */
    private static final Pattern LOG_PATTERN = Pattern.compile("(?<=\\{)[^}]*(?=})");

    @Override
    public void handle(PermissionMeta meta, Logger logger, HttpServletRequest request, HttpServletResponse response) {
        String template = logger.template();
        UserDO user = LocalUser.getLocalUser();
        template = this.parseTemplate(template, user, request, response);
        String permission = "";
        if (meta != null) {
            permission = StringUtils.isEmpty(meta.value()) ? meta.value() : meta.value();
        }
        Integer userId = user.getId();
        String username = user.getUsername();
        String method = request.getMethod();
        String path = request.getServletPath();
        Integer status = response.getStatus();
        logService.createLog(template, permission, userId, username, method, path, status);
    }

    private String parseTemplate(String template, UserDO user, HttpServletRequest request, HttpServletResponse response) {
        // 调用 get 方法
        Matcher m = LOG_PATTERN.matcher(template);
        while (m.find()) {
            String group = m.group();
            String property = this.extractProperty(group, user, request, response);
            template = template.replace("{" + group + "}", property);
        }
        return template;
    }

    private String extractProperty(String item, UserDO user, HttpServletRequest request, HttpServletResponse response) {
        int i = item.lastIndexOf('.');
        String obj = item.substring(0, i);
        String prop = item.substring(i + 1);
        switch (obj) {
            case "user":
                if (user == null) {
                    return "";
                }
                return BeanUtil.getValueByPropName(user, prop);
            case "request":
                return BeanUtil.getValueByPropName(request, prop);
            case "response":
                return BeanUtil.getValueByPropName(response, prop);
            default:
                return "";
        }
    }
}

//日志管理业务代码
@Service
public class LogServiceImpl extends ServiceImpl<LogMapper, LogDO> implements LogService {

    @Override
    public IPage<LogDO> getLogPage(Integer page, Integer count, String name, Date start, Date end) {
        Page<LogDO> pager = new Page<>(page, count);
        LambdaQueryWrapper<LogDO> lq=new LambdaQueryWrapper<>();
        if(!StringUtils.isEmpty(name)){
            lq.eq(LogDO::getUsername,name);
        }
        if(!StringUtils.isEmpty(start)&&!StringUtils.isEmpty(end)){
            lq.gt(LogDO::getCreateTime,start);
            lq.lt(LogDO::getCreateTime,end);
        }
        lq.orderByDesc(LogDO::getCreateTime);
        IPage<LogDO> logDOIPage = this.baseMapper.selectPage(pager, lq);
        return logDOIPage;
    }

    @Override
    public IPage<LogDO> searchLogPage(Integer page, Integer count, String name, String keyword, Date start, Date end) {
        Page<LogDO> pager = new Page<>(page, count);
        IPage<LogDO> iPage = this.baseMapper.searchLogsByUsernameAndKeywordAndRange(pager, name, "%" + keyword + "%", start, end);
        return iPage;
    }

    @Override
    public IPage<String> getUserNamePage(Integer page, Integer count) {
        Page<LogDO> pager = new Page<>(page, count);
        IPage<String> iPage = this.baseMapper.getUserNames(pager);
        return iPage;
    }

    @Override
    public boolean createLog(String message, String permission, Integer userId, String username, String method, String path, Integer status) {
        LogDO record = LogDO.builder()
                .message(message)
                .userId(userId)
                .username(username)
                .statusCode(status)
                .method(method)
                .path(path)
                .build();
        if (permission != null) {
            record.setPermission(permission);
        }
        record.setCreateTime(new Date());
        return this.baseMapper.insert(record) > 0;
    }
}
```

### 权限管理

<font color = 'red'>权限管理的图换成这个</font>

![权限管理](https://gitee.com/DoubleZHEz/mine/raw/main/ImageRepository/Library/Student_png/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86.png)

```sequence
title: 权限管理时序图
participant 管理员
管理员 -> 权限管理 Action: 访问权限管理界面
权限管理 Action -> 权限管理界面: 跳转至权限管理界面
权限管理界面 -> 权限管理界面: 选择角色
权限管理界面 -> PermissionService: 查询该角色所拥有的权限
PermissionService -> PermissionService: 根据 roleId 查询\n Permission_Role 数据表
	note right of 角色: 注：\n默认该图中管理员拥有权限管理的权限
PermissionService --> 权限管理界面: 返回 Permission_Role 数据
权限管理界面 -> PermissionService: 修改该角色所拥有的权限
PermissionService -> PermissionService: 根据 roleId 和 \npermissionId 修改\n Permission_Role 数据表
PermissionService -> 角色: 将权限赋予到角色
PermissionService --> 权限管理界面: 返回 Permission_Role 数据
participant 角色
```

```java
@Service
public class PermissionServiceImpl extends ServiceImpl<PermissionMapper, PermissionDO> implements PermissionService {

    @Override
    public List<PermissionDO> getPermissionByGroupId(Integer groupId) {
        return this.baseMapper.selectPermissionsByGroupId(groupId);
    }

    @Override
    public List<PermissionDO> getPermissionByGroupIds(List<Integer> groupIds) {
        return this.baseMapper.selectPermissionsByGroupIds(groupIds);
    }

    @Override
    public Map<Long, List<PermissionDO>> getPermissionMapByGroupIds(List<Integer> groupIds) {
        HashMap map = new HashMap(groupIds.size());
        groupIds.stream().forEach(groupId -> {
            List<PermissionDO> permissions = this.baseMapper.selectPermissionsByGroupId(groupId);
            map.put(groupId, permissions);
        });
        return map;
    }

    @Override
    public List<Map<String, List<Map<String, String>>>> structuringPermissions(List<PermissionDO> permissions) {
        Map<String, List<Map<String, String>>> tmp = new HashMap();
        permissions.forEach(permission -> {
            if (!tmp.containsKey(permission.getModule())) {
                Map<String, String> tiny = new HashMap();
                tiny.put("module", permission.getModule());
                tiny.put("permission", permission.getName());
                List<Map<String, String>> mini = new ArrayList();
                mini.add(tiny);
                tmp.put(permission.getModule(), mini);
            } else {
                Map<String, String> tiny = new HashMap();
                tiny.put("module", permission.getModule());
                tiny.put("permission", permission.getName());
                tmp.get(permission.getModule()).add(tiny);
            }
        });
        List<Map<String, List<Map<String, String>>>> structualPermissions = new ArrayList();
        tmp.forEach((k, v) -> {
            Map<String, List<Map<String, String>>> ttmp = new HashMap();
            ttmp.put(k, v);
            structualPermissions.add(ttmp);
        });
        return structualPermissions;
    }

    @Override
    public Map<String, List<String>> structuringPermissionsSimply(List<PermissionDO> permissions) {
        // mod      permission.names
        Map<String, List<String>> res = new HashMap<>();
        permissions.forEach(permission -> {
            if (res.containsKey(permission.getModule())) {
                List<String> mod = res.get(permission.getModule());
                mod.add(permission.getName());
            } else {
                List<String> mod = new ArrayList<>();
                mod.add(permission.getName());
                res.put(permission.getModule(), mod);
            }
        });
        return res;
    }

    @Override
    public List<PermissionDO> getPermissionByGroupIdsAndModule(List<Integer> groupIds, String module) {
        return this.baseMapper.selectPermissionsByGroupIdsAndModule(groupIds, module);
    }
}
```

### 角色管理

<font color='red'>换截图</font>

![角色管理](https://gitee.com/DoubleZHEz/mine/raw/main/ImageRepository/Library/Student_png/%E8%A7%92%E8%89%B2%E7%AE%A1%E7%90%86.png)

```sequence
title: 角色管理时序图
participant 管理员
管理员 -> 角色管理 Action: 访问角色管理页面
角色管理 Action -> 角色管理界面: 跳转至角色管理界面
角色管理界面 -> RoleService: 获取所有角色
RoleService -> RoleService: 查询 Role 数据表
	note right of RoleService: 注：\n默认该图中管理员拥有角色管理的权限
RoleService --> 角色管理界面: 返回 Role 数据表数据
角色管理界面 -> RoleService: 新增角色
RoleService -> RoleService: 插入 Role 数据表
RoleService --> 角色管理界面: 返回 Role 数据表数据
```

```java
@Service
public class GroupServiceImpl extends ServiceImpl<GroupMapper, GroupDO> implements GroupService {

    @Autowired
    private PermissionService permissionService;

    @Autowired
    private UserGroupMapper userGroupMapper;

    @Override
    public List<GroupDO> getUserGroupsByUserId(Integer userId) {
        return this.baseMapper.selectGroupsByUserId(userId);
    }

    @Override
    public List<Integer> getUserGroupIdsByUserId(Integer userId) {
        return this.baseMapper.selectUserGroupIds(userId);
    }

    @Override
    public IPage<GroupDO> getGroupPage(int page, int count) {
        Page<GroupDO> pager = new Page<>(page, count);
        return this.baseMapper.selectPage(pager, null);
    }

    @Override
    public boolean checkGroupExistById(Integer id) {
        return this.baseMapper.selectCountById(id) > 0;
    }

    @Override
    public GroupPermissionBO getGroupAndPermissions(Integer id) {
        GroupDO group = this.baseMapper.selectById(id);
        List<PermissionDO> permissions = permissionService.getPermissionByGroupId(id);
        return new GroupPermissionBO(group, permissions);
    }

    @Override
    public boolean checkGroupExistByName(String name) {
        QueryWrapper<GroupDO> wrapper = new QueryWrapper<>();
        wrapper.lambda().eq(GroupDO::getName, name);
        return this.baseMapper.selectCount(wrapper) > 0;
    }

    @Override
    public boolean checkIsRootByUserId(Integer userId) {
        QueryWrapper<UserGroupDO> wrapper = new QueryWrapper<>();
        Integer rootGroupId = this.getParticularGroupIdByLevel(GroupLevelEnum.ROOT);
        wrapper.lambda().eq(UserGroupDO::getUserId, userId)
                .eq(UserGroupDO::getGroupId, rootGroupId);
        UserGroupDO relation = userGroupMapper.selectOne(wrapper);
        return relation != null;
    }

    @Override
    public boolean deleteUserGroupRelations(Integer userId, List<Integer> deleteIds) {
        if (deleteIds == null || deleteIds.isEmpty()) {
            return true;
        }
        if (checkIsRootByUserId(userId)) {
            throw new ForbiddenException(10078);
        }
        QueryWrapper<UserGroupDO> wrapper = new QueryWrapper<>();
        wrapper.lambda()
                .eq(UserGroupDO::getUserId, userId)
                .in(UserGroupDO::getGroupId, deleteIds);
        return userGroupMapper.delete(wrapper) > 0;
    }

    @Override
    public boolean addUserGroupRelations(Integer userId, List<Integer> addIds) {
        if (addIds == null || addIds.isEmpty()) {
            return true;
        }
        boolean ok = checkGroupExistByIds(addIds);
        if (!ok) {
            throw new ForbiddenException(10077);
        }
        List<UserGroupDO> relations = addIds.stream().map(it -> new UserGroupDO(userId, it)).collect(Collectors.toList());
        return userGroupMapper.insertBatch(relations) > 0;
    }

    @Override
    public List<Integer> getGroupUserIds(Integer id) {
        QueryWrapper<UserGroupDO> wrapper = new QueryWrapper<>();
        wrapper.lambda().eq(UserGroupDO::getGroupId, id);
        List<UserGroupDO> list = userGroupMapper.selectList(wrapper);
        return list.stream().map(UserGroupDO::getUserId).collect(Collectors.toList());
    }

    @Override
    public GroupDO getParticularGroupByLevel(GroupLevelEnum level) {
        if (GroupLevelEnum.USER == level) {
            return null;
        } else {
            QueryWrapper<GroupDO> wrapper = new QueryWrapper<>();
            wrapper.lambda().eq(GroupDO::getLevel, level.getValue());
            GroupDO groupDO = this.baseMapper.selectOne(wrapper);
            return groupDO;
        }
    }

    @Override
    public Integer getParticularGroupIdByLevel(GroupLevelEnum level) {
        GroupDO group = this.getParticularGroupByLevel(level);
        return group == null ? 0 : group.getId();
    }

    private boolean checkGroupExistByIds(List<Integer> ids) {
        return ids.stream().allMatch(this::checkGroupExistById);
    }
}
```

### 类别管理

<font color='red'>换截图</font>

![类别管理](https://gitee.com/DoubleZHEz/mine/raw/main/ImageRepository/Library/Student_png/%E7%B1%BB%E5%88%AB%E7%AE%A1%E7%90%86.png)

```sequence
title: 类别管理时序图
participant 管理员
管理员 -> 类别管理 Action: 访问类别管理页面
类别管理 Action -> 类别管理界面: 跳转至类别管理界面
类别管理界面 -> CategoryService: 获取所有类别
CategoryService -> CategoryService: 查询 Category 数据表
	note right of CategoryService: 注：\n默认该图中管理员拥有类别管理的权限
CategoryService --> 类别管理界面: 返回 Category 数据表数据
类别管理界面 -> CategoryService: 新增类别
CategoryService -> CategoryService: 插入 Category 数据表
CategoryService --> 类别管理界面: 返回 Category 数据表数据
```

```java
@Service
public class CategoryServiceImpl extends ServiceImpl<CategoryMapper, CategoryDO> implements CategoryService {

    @Resource
    private CategoryMapper categoryMapper;

    @Override
    public boolean createCategory(CreateOrUpdateCategoryDTO validator) {
        CategoryDO  categoryDO = new CategoryDO();
        categoryDO.setName(validator.getName());
        categoryDO.setDescription(validator.getDescription());
        return categoryMapper.insert(categoryDO) > 0;
    }

    @Override
    public boolean updateCategory(CategoryDO categoryDO, CreateOrUpdateCategoryDTO validator) {
        categoryDO.setName(validator.getName());
        categoryDO.setDescription(validator.getDescription());
        return categoryMapper.updateById(categoryDO) > 0;
    }

    @Override
    public boolean deleteById(Integer id) {
        return categoryMapper.deleteById(id) > 0;
    }

    @Override
    public List<CategoryDO> getAll() {
        return categoryMapper.selectList(null);
    }

    @Override
    public List<CategoryDO> show() {
        return categoryMapper.show();
    }
}
```

### 用户管理

<font color='red'>换截图</font>

![用户管理](https://gitee.com/DoubleZHEz/mine/raw/main/ImageRepository/Library/Student_png/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86.png)

```sequence
title: 用户管理时序图
participant 管理员
管理员 -> 用户管理 Action: 访问用户管理页面
用户管理 Action -> 用户管理界面: 跳转至用户管理界面
用户管理界面 -> AdminService: 获取所有用户
AdminService -> AdminService: 查询 User 数据表
AdminService --> 用户管理界面: 返回 User 数据表数据
用户管理界面 -> AdminService: 修改用户信息
	note right of AdminService: 注：\n默认该图中管理员拥有用户管理的权限
AdminService -> AdminService: 更新 User 数据表
AdminService --> 用户管理界面: 返回 User 数据表数据
用户管理界面 -> AdminService: 新添用户
AdminService -> AdminService: 插入 User 数据表
AdminService --> 用户管理界面: 返回 User 数据表数据
```

```java
@Override
public IPage<UserDO> getUserPageByGroupId(Integer groupId, Integer count, Integer page) {
    Page<UserDO> pager = new Page<>(page, count);
    IPage<UserDO> iPage;
    // 如果group_id为空，则以分页的形式返回所有用户
    if (groupId == null) {
        QueryWrapper<UserDO> wrapper = new QueryWrapper<>();
        Integer rootUserId = userService.getRootUserId();
        wrapper.lambda().ne(UserDO::getId, rootUserId);
        iPage = userService.page(pager, wrapper);
    } else {
        iPage = userService.getUserPageByGroupId(pager, groupId);
    }
    return iPage;
}

@Override
public boolean changeUserPassword(Integer id, ResetPasswordDTO dto) {
    throwUserNotExistById(id);
    return userIdentityService.changePassword(id, dto.getNewPassword());
}

@Transactional
@Override
public boolean deleteUser(Integer id) {
    throwUserNotExistById(id);
    boolean userRemoved = userService.removeById(id);
    QueryWrapper<UserIdentityDO> wrapper = new QueryWrapper<>();
    wrapper.lambda().eq(UserIdentityDO::getUserId, id);
    return userRemoved && userIdentityService.remove(wrapper);
}

@Override
public boolean updateUserInfo(Integer id, UpdateUserInfoDTO validator) {
    List<Integer> newGroupIds = validator.getGroupIds();
    Integer rootGroupId = groupService.getParticularGroupIdByLevel(GroupLevelEnum.ROOT);
    boolean anyMatch = newGroupIds.stream().anyMatch(it -> it.equals(rootGroupId));
    if (anyMatch) {
        throw new ForbiddenException(10073);
    }
    List<Integer> existGroupIds = groupService.getUserGroupIdsByUserId(id);
    // 删除existGroupIds有，而newGroupIds没有的
    List<Integer> deleteIds = existGroupIds.stream().filter(it -> !newGroupIds.contains(it)).collect(Collectors.toList());
    // 添加newGroupIds有，而existGroupIds没有的
    List<Integer> addIds = newGroupIds.stream().filter(it -> !existGroupIds.contains(it)).collect(Collectors.toList());
    return groupService.deleteUserGroupRelations(id, deleteIds) && groupService.addUserGroupRelations(id, addIds);
}
